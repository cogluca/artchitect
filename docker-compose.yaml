version: "3.8"

services:
  # PHP Service
  architect_backend_php_laravel:
    container_name: architect_backend_php_laravel
    build:
      context: ./backend/php/laravel
      dockerfile: ./.docker/php/Dockerfile
    expose:
      - 9000
    working_dir: /usr/src/architect/backend/php/laravel
    volumes:
      - ./backend/php/laravel:/usr/src/architect/backend/php/laravel
      - ./backend/php/laravel/public:/usr/src/architect/backend/php/laravel/public
    depends_on:
      - architect_database_mysql
    networks:
      - architect_network

  # Watchful service
  architect_backend_javascript_watchful:
    container_name: architect_backend_javascript_watchful
    restart: always
    build:
      context: ./backend/javascript/watchful
      dockerfile: ./.docker/Dockerfile
    working_dir: /usr/src/architect/backend/javascript/watchful
    volumes:
      - /usr/src/architect/backend/javascript/watchful/node_modules
      - ./backend/javascript/watchful:/usr/src/architect/backend/javascript/watchful
    depends_on:
      - architect_rabbitmq
    networks:
      - architect_network

  # Balancer service Rust
  architect_backend_rust_balancer:
    container_name: architect_backend_rust_balancer
    build:
      context: ./backend/rust/balancer
      dockerfile: ./.docker/Dockerfile
    working_dir: /usr/src/architect/backend/rust/balancer
    expose:
      - 5500
    volumes:
      - /usr/src/architect/backend/rust/balancer/target
      - ./backend/rust/balancer:/usr/src/architect/backend/rust/balancer
    networks:
      - architect_network

  # Balancer service Javascript
  architect_backend_javascript_balancer:
    container_name: architect_backend_javascript_balancer
    build:
      context: ./backend/javascript/balancer
      dockerfile: ./.docker/Dockerfile
    working_dir: /usr/src/architect/backend/javascript/balancer
    expose:
      - 5010
    volumes:
      - /usr/src/architect/backend/javascript/balancer/node_modules
      - ./backend/javascript/balancer:/usr/src/architect/backend/javascript/balancer
    networks:
      - architect_network

  # MySQL Service
  architect_database_mysql:
    container_name: architect_database_mysql
    image: mysql:8.0.20
    platform: linux/x86_64
    restart: always
    volumes:
      - ./backend/php/laravel/.docker/database/mysql/architect:/var/lib/mysql
    ports:
      - 3360:3306
    environment:
      MYSQL_DATABASE: architect_database_mysql
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: architect
      MYSQL_PASSWORD: architect
    networks:
      - architect_network

  # MySQL Testing Service
  architect_database_mysql_testing:
    container_name: architect_database_mysql_testing
    image: mysql:8.0.20
    platform: linux/x86_64
    restart: always
    volumes:
      - ./backend/php/laravel/.docker/database/mysql/architect_testing:/var/lib/mysql
    ports:
      - 3370:3306
    environment:
      MYSQL_DATABASE: architect_database_mysql_testing
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: architect
      MYSQL_PASSWORD: architect
    networks:
      - architect_network

  # Nginx Laravel Service
  architect_nginx_laravel:
    container_name: architect_nginx_laravel
    build:
      context: ./nginx/laravel
      dockerfile: ./Dockerfile
    ports:
      - 8000:80
    volumes:
      - ./backend/php/laravel/public:/usr/src/architect/backend/php/laravel/public
    depends_on:
      - architect_backend_php_laravel
    environment:
      - NGINX_FPM_HOSTNGINX_FPM_HOST=architect_backend_php_laravel
      - NGINX_ROOT=/usr/src/architect/backend/php/laravel/public
    networks:
      - architect_network

  # Nginx Balancer Service
  architect_nginx_balancer:
    container_name: architect_nginx_balancer
    build:
      context: ./nginx/balancer
      dockerfile: ./Dockerfile
    environment:
      - NGINX_FPM_HOST=architect_nginx_balancer
    ports:
      - 8080:80
    depends_on:
      - architect_backend_javascript_balancer
      - architect_backend_rust_balancer
    networks:
      - architect_network

  # RabbitMQ Service
  architect_rabbitmq:
    container_name: architect_rabbitmq
    image: rabbitmq:3.9-management
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: architect
      RABBITMQ_DEFAULT_PASS: architect
    ports:
      # AMQP protocol port
      - 5672:5672
      # UI Management port
      - 15672:15672
    networks:
      - architect_network

  # Homepage
  architect_frontend_react_homepage:
    container_name: architect_frontend_react_homepage
    build:
      context: ./frontend/react/homepage
      dockerfile: ./Dockerfile
    working_dir: /usr/src/architect/frontend/react/homepage
    restart: always
    ports:
      #This should be exposed by a nginx service
      - 3010:3000
    volumes:
      - ./frontend/react/homepage:/usr/src/architect/frontend/react/homepage
    depends_on:
      - architect_nginx_laravel
      - architect_nginx_balancer
      - architect_frontend_react_authentication
    env_file:
      - ./frontend/react/homepage/.env.local
    networks:
      - architect_network

  # User Authentication
  architect_frontend_react_authentication:
    container_name: architect_frontend_react_authentication
    build:
      context: ./frontend/react/authentication
      dockerfile: ./.docker/Dockerfile
    working_dir: /usr/src/architect/frontend/react/authentication
    restart: always
    ports:
      - 3030:3000
    volumes:
      - /usr/src/architect/frontend/react/authentication/node_modules
      - ./frontend/react/authentication:/usr/src/architect/frontend/react/authentication
    depends_on:
      - architect_rabbitmq
    env_file:
      - ./frontend/react/authentication/.env.local
    networks:
      - architect_network

# Docker Network
networks:
  architect_network:
    driver: bridge
